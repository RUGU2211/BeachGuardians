rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    // Admin check: valid if any of the following is true:
    // - An admin registry doc exists at admins/{uid}
    // - A custom claim 'admin' is set on the auth token
    // - The users/{uid} profile shows role='admin' AND isAdminVerified=true
    // Note: We check exists() before get() to avoid errors when profile doesn't exist yet
    function isAdmin() {
      return request.auth != null && (
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
        request.auth.token.admin == true ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdminVerified == true
        )
      );
    }

    // Helper: Check if current user is admin based on their own profile data
    // This avoids circular dependency when reading users/{uid} where uid == request.auth.uid
    // Use this when checking permissions on the user's own profile to prevent circular reads
    function isAdminByResource(resourceData) {
      return request.auth != null && (
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
        request.auth.token.admin == true ||
        (resourceData.role == 'admin' && resourceData.isAdminVerified == true)
      );
    }

    // Users: owner can read/write their document; role protected
    match /users/{uid} {
      // List: explicitly allow admins to run collection-wide queries for analytics
      allow list: if isAdmin();

      // Read (get and query per document): owner always allowed, admin check uses resource.data to avoid circular dependency
      // Using `allow read` ensures queries evaluate per-document with `resource.data`
      allow read: if isSignedIn() && (
        uid == request.auth.uid || 
        isAdminByResource(resource.data) || 
        resource.data.enableLiveLocation == true
      );

      // Create: owner can create their own profile with any role during signup
      // Admin can create profiles for others
      // Note: We allow users to set role='admin' during initial signup
      // but they need to verify via OTP to activate admin privileges
      allow create: if isSignedIn() && (
        uid == request.auth.uid ||
        isAdmin()
      );

      // Update: owner with immutable role, or admin (who may change role to allowed values).
      allow update: if isSignedIn() && (
        (uid == request.auth.uid &&
          request.resource.data.role == resource.data.role) ||
        (isAdmin() &&
          (!request.resource.data.role ||
           request.resource.data.role in ['user','volunteer','admin']))
      );

      // Delete: owner or admin
      allow delete: if isSignedIn() && (uid == request.auth.uid || isAdmin());
    }

    // Events: signed-in can read; only admins write
    match /events/{eventId} {
      allow read: if true; // public visibility
      allow write: if isAdmin();
      // Allow event deletion by admins or the event organizer
      allow delete: if isAdmin() || (isSignedIn() && resource.data.organizerId == request.auth.uid);

      // Subcollection: registrations under each event
      match /registrations/{regId} {
        // Helper: event organizer check
        function isEventOrganizer() {
          return isSignedIn() && (
            get(/databases/$(database)/documents/events/$(eventId)).data.organizerId == request.auth.uid
          );
        }

        // Read: owner (by field), admin, or the event organizer
        allow read: if isSignedIn() && (
          resource.data.userId == request.auth.uid || isAdmin() || isEventOrganizer()
        );
        // Create: owner (by field) or admin manages registrations
        // Organizers may also create (e.g., adding attendees manually)
        allow create: if isSignedIn() && (
          isAdmin() || request.resource.data.userId == request.auth.uid || isEventOrganizer()
        );
        // Update: owner with immutable userId, admin, or organizer (immutable userId)
        allow update: if isSignedIn() && (
          (resource.data.userId == request.auth.uid &&
           request.resource.data.userId == resource.data.userId) ||
          (isEventOrganizer() && request.resource.data.userId == resource.data.userId) ||
          isAdmin()
        );
        // Delete: owner, admin, or event organizer
        allow delete: if isSignedIn() && (
          resource.data.userId == request.auth.uid || isAdmin() || isEventOrganizer()
        );
      }
    }

    // (Removed) Top-level registrations path to avoid schema mismatch

    // Waste logs: owned by user; Cloud Functions will recalc leaderboard
    match /wasteLogs/{logId} {
      // List: allow admins to aggregate across all waste logs for analytics
      allow list: if isAdmin();

      // Read: owner (by userId or loggedBy) or admin
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.loggedBy == request.auth.uid ||
        isAdmin()
      );

      // Create: must set userId or loggedBy to self
      allow create: if isSignedIn() && (
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.loggedBy == request.auth.uid
      );

      // Update: owner (with immutable userId/loggedBy) or admin
      allow update: if isSignedIn() && (
        (
          (resource.data.userId == request.auth.uid &&
           request.resource.data.userId == resource.data.userId) ||
          (resource.data.loggedBy == request.auth.uid &&
           request.resource.data.loggedBy == resource.data.loggedBy)
        ) ||
        isAdmin()
      );

      // Delete: owner or admin
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Leaderboard: client-read only; writes blocked (Admin SDK writes via Functions)
    match /leaderboard/{uid} {
      allow read: if true;
      allow write: if false;
    }

    // Newsletter subscribers: public read for counts; public create to subscribe; updates/deletes only by admins
    match /newsletter_subscribers/{sid} {
      // Allow anyone to read to show subscriber counts on the landing page
      allow read: if true;
      // Allow anyone to create a subscription entry
      allow create: if true;
      // Only admins can modify or delete existing entries
      allow update, delete: if isAdmin();
    }

    // NGOs public profiles: publicly readable; writes restricted to admins or profile owner during signup
    match /ngos/{uid} {
      allow read: if true;
      // Allow users to create their own NGO profile during signup (same uid)
      // Admins can create/modify any NGO profile
      allow write: if isSignedIn() && (
        uid == request.auth.uid ||
        isAdmin()
      );
    }

    // Admins registry: allow only admins to read/write
    match /admins/{uid} {
      allow read, write: if isAdmin();
    }

    // Default deny fallback
    match /{document=**} {
      allow read, write: if false;
    }
  }
}